---
title: "Data Unification"
author: "Shai Vaz"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(knitr.kable.NA = '')
```

```{r, include=FALSE}
# Table
library(kableExtra)
library(tinytable)

# Graphics
library(ggplot2)
library(ggpattern)

# Geographic
library(sf)

# Econometrics
library(fixest)
library(ivreg)
library(modelsummary)

# Data Wrangling
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(readxl)
library(forcats)
library(purrr)

# Personal functions
source("../Functions/bulk_rds.R")
source("../Functions/recovery_counterfactual.R")
source("../Functions/structural_parameters.R")
```

# Importing files

```{r}
bulk_read_rds(
  # geographic
  muni_to_amc,
  amc_1991_2022,
  brazil,
  # prices
  national_prices,
  cattle_prices_cepea_in_census_years,
  ipca_census_years,
  # census data
  agg_census_data,
  # survey data
  cattle_heads_ppm,
  # instruments
  ssiv,
  # controls
  tc_by_amc,
  ma_long,
  si_by_amc,
  # mapbiomas
  land_cover_agg,
  transition_agg,
  past_qual,
  # carbon biomass
  biomass
  )
```

Read terraclimate climatic controls. 

```{r}
terraclimate <- read_csv(
  "../Variables/terraclimate.csv", 
  col_types = "cnnnnnnnn")
```

# Discount factor

```{r}
beta = 0.9
```

# Intensive margin


## I.M. Database

```{r}
int_data <- left_join(
  # first I join shifters with prices
  # then I extract data from t+1
  ssiv |> 
    select(code_amc, year, area_amc, ssiv),
  
  cattle_prices_cepea_in_census_years,
  
  by = c("year" = "census_year")
  ) |> 
  ########## get next period prices and shifters
  mutate(
    mean_price_2 = if_else(
      year == 2006 | year == 2017,
      lead(mean_price),
      NA),
    
    mean_nominal_price_2 = if_else(
      year == 2006 | year == 2017,
      lead(mean_nominal_price),
      NA),
    
    ssiv_2 = if_else(
      year == 2006 | year == 2017,
      lead(ssiv),
      NA)
  ) |>
  ############ join with census data
  right_join(
    agg_census_data,
    
    by = c("code_amc", "year")
  ) |>
    # drop observations without cattle sales
  filter(
    ! is.na(av_price_slaughter)
  ) |> 
    # calculate normalized head count (intensity)
  mutate(
    h = cattle_heads_big/area_amc
  ) |> 
  ############ join with inflation
  left_join(
    ipca_census_years,
    
    by = c("year" = "census_year")
  ) |> 
  ############ deflate and project ahead local prices
             # using IPCA ratio (index_2022/index)
  mutate(
    local_price = av_price_slaughter * (index_2022/index)
                  *1000,
    
    local_price_2 = av_price_slaughter *(index_2022/index)
                    *(mean_price_2/mean_price)*1000,
  ) |> 
  ############# include controls
  left_join(
    tc_by_amc,
    by = "code_amc"
  ) |> 
  left_join(
    ma_long,
    by = c("code_amc", "year")
  ) |> 
  left_join(
    si_by_amc,
    by = "code_amc"
  ) |> 
  ############ include land use
  left_join(
    land_cover_agg,
    
    by = c("code_amc", "year")
  ) |> 
              # calculate pasture share (in t and only in 2006)
  mutate(
    past_share = if_else(is.na(pasture), 0, pasture/area_amc),
    
    pasture_2006 = if_else(year == 2006, pasture, lag(pasture)),
    
    past_share_2006 = if_else(is.na(pasture_2006), 0, pasture_2006/area_amc)
  ) |> 
  ############ include pasture quality
  left_join(
    past_qual |> 
            ####### testing lead high share
            mutate( 
              .by = code_amc,
              high_share = dplyr::lead(high_share)
            ),
    by = c("code_amc", "year")
  ) |>
            # filter out one NA on total pastures
            # only case is Afuá-PA (in Marajó island)
  filter(
    ! is.na(total)
  ) |> 
  ########### include carbon biomass
  left_join(
    biomass,
    by = "code_amc"
  ) |> 
            # calculate carbon density in CO2
            # uses atomic weight of C (12) and CO2 (44)
            # and the fact that biomass is about 50% C
  mutate(
    biomass_co2 = (biomass/2)*(44/12),
    biomass_density = biomass_co2/area_amc
  ) |> 
  ############ terraclimate controls
  left_join(
    terraclimate,
    
    by = c("code_amc", "year")
  ) |> 
  ########### remove NA in transport cost
  # it is NA for Conde - PB
  filter(
    !is.na(tc_median)
  )
```


## IV 

```{r}
iv <- feols(
  data = int_data,
  h ~
    ma_norm
  + si_median
  + year
#  + tmmn_min + tmmx_max
  + tmmn_mean + tmmx_mean
  + tc_median

  | sw(1,main_biome, code_state, code_amc)
  
  | local_price + local_price_2 + high_share ~ ssiv + ssiv_2 + pdsi_min,
  
  panel.id = c("code_amc","year"),
  cluster = "code_amc"
  )

etable(
  iv, 
  stage=2, 
  digits = 4,
  fitstat = ~ n + f + ivf)
```

Etable with phi:

```{r}
phi_iv = function(x) {
  # Extract coefficients
  coefs <- coef(x)
  
  # Calculate phi
  phi <- - coefs["fit_local_price_2"] / (beta * coefs["fit_local_price"]) - 1
  
  # Return phi value
  return(phi)
}

extralines_register("phi_iv", phi_iv, "phi")


etable(
  iv, 
  stage = 2, 
  digits = 4,
  fitstat = ~ n + f + ivf,
  extralines = ~ phi_iv
)

```


## OLS 

```{r}
ols <- feols(
  data = int_data,
  h ~
    local_price
  + local_price_2
  + high_share
  + ma_norm
  + si_median
  + year
  + tmmn_min
  + tmmx_max 
  + tmmn_mean
  + tmmx_mean
  
  + high_share
  
  | sw(1,main_biome,code_state, code_amc),
  panel.id = c("code_amc","year"),
  cluster = "code_amc"
  )

etable(
  ols, 
  stage=2, 
  digits = 5,
  fitstat = ~ n + f + ivf
  )
```


```{r}
phi_ols = function(x) {
  # Extract coefficients
  coefs <- stats::coef(x)
  
  # Calculate phi
  phi <- ( - coefs["local_price_2"] ) / (beta * coefs["local_price"]) - 1
  
  # Return phi value
  return(phi)
}

extralines_register("phi_ols", phi_ols, "phi")

etable(
  ols, 
  stage = 2, 
  digits = 4,
  fitstat = ~ n + f + wf + r2 + wr2 + ar2,
  extralines = ~ phi_ols
)

```

## Poisson

```{r}
pois <- feglm(
  data = int_data,
  h ~
    local_price
  + local_price_2
  + high_share
  + ma_norm
  + si_median
  + year
  + tmmn_min
  + tmmx_max 
  + tmmn_mean
  + tmmx_mean
  + high_share
  
  | sw(1, main_biome, code_state, code_amc),
  panel.id = c("code_amc", "year"),
  cluster = "code_amc",
  family = "poisson"  # Specifies Poisson regression
)

etable(pois)
```
# Extensive margin

## E.M. Database

Import Euler-Mascheroni constant:

```{r}
gamma = -digamma(1)
```

Create a function to calculate the intertemporal difference $\beta x_{mt+1} - x_{mt}$:

```{r}
tdif = \(x) beta * dplyr::lead({{x}}) - {{x}} 
```


```{r}
# This version has the whole time series
ext_data_complete <- transition_agg |> 
  ############# get transition probabilities
  select(
    code_amc,
    year = year_from,
    rho_1 = natural_pasture
  ) |> 
  mutate(
    rho_2 = lead(rho_1),
    rho_3 = lead(rho_1, 2),
    rho_lag = lag(rho_1),
    .by = code_amc
  ) |> 
  ########### include ssiv
  left_join(
    ssiv |>  select(code_amc, area_amc, ssiv, year),
    
    by = c("code_amc", "year")
  ) |> 
  ############ join with census data
  left_join(
    agg_census_data |> 
      select(
        year,
        code_amc, 
        main_biome,
        cattle_heads,
        cattle_heads_big
      ),
    
    by = c("code_amc", "year")
  ) |> 
  # calculate normalized head count (intensity)
  mutate(
    h = cattle_heads_big/area_amc
  ) |>
  ############# include controls
  left_join(
    tc_by_amc, #|> select(code_amc, tc_mean, tc_median),
    by = "code_amc"
  ) |> 
  left_join(
    ma_long,
    by = c("code_amc", "year")
  ) |> 
  left_join(
    si_by_amc, #|> select(code_amc, si_mean, si_median),
    by = "code_amc"
  ) |>
  ############ include land use
  left_join(
    land_cover_agg,
    
    by = c("code_amc", "year")
  )  |> 
  ############ include pasture quality
  left_join(
    past_qual,
    by = c("code_amc", "year")
  ) |> 
  ############ terraclimate controls
  left_join(
    terraclimate,
    
    by = c("code_amc", "year")
  )|> 
  ########### include carbon biomass
  left_join(
    biomass,
    by = "code_amc"
  ) |> 
  # calculate carbon density in CO2
  mutate(
    biomass_co2 = (biomass/2)*(44/12),
    biomass_density = biomass_co2/area_amc
  ) |> 
  ############# calculate regression variables
  # difference in cost factors
  mutate(
    .by = "code_amc",
    across(
      .cols = c(high_share, tmmn_min:tmmx_mean, pr),
      .fns = tdif,
      .names = "{.col}_tdif"
      )
  ) |> 
  mutate(
    .by = "code_amc",
    
    pr_lag = lag(pr),
    ssiv_lag = lag(ssiv),
    
    y = log(rho_1/(1-rho_1)) - beta* log(rho_2) + beta*gamma,
    
    x1 = 0.45*(cattle_heads_big**2),
    
    x2 = 0.45*(h)**2,
    
    x3 = 0.45*(cattle_heads_big/pasture)**2,
    
    x4 = 0.45*(cattle_heads/area_amc)**2,
    
    x5 = 0.45*(cattle_heads/pasture)**2,
    
    year_tdif = (beta + (beta - 1) * year)
  ) 

# this is the version for the regressions
ext_data <- ext_data_complete |> 
  ########## remove probability 0 and 1 (impossible log odds)
  filter(
    rho_1 != 0 &
    rho_1 != 1 &
    rho_2 != 0 
  ) |> 
  ########## filter to census years
  filter(
    year == 2006 | year == 2017
  ) |> 
  ########## remove NA
  filter(
    !is.na(x2)
  ) 
```


## IV with Census

```{r}
ext_iv <- feols(
  data = ext_data,
  y ~ 
  x2
#  + high_share_tdif
  + ma_norm
  + si_median
  + biomass_density
  + year_tdif
#  + tmmn_min_tdif + tmmx_max_tdif 
  + tmmn_mean_tdif + tmmx_mean_tdif
#  + pr_tdif 
  + tc_median
    
  | sw(1,main_biome, code_state)
  | high_share_tdif ~ pdsi_min,
  
  panel.id = c("code_amc","year"),
  cluster = "code_amc"
  )

etable(
  ext_iv,
  fitstat = ~ n + f + ivf
  )
```

## OLS with census

```{r}
ext_ols <- feols(
  data = ext_data,
  y ~ 
  x2
  + high_share_tdif
  + biomass_density
  + ma_norm
  + si_median
  + year_tdif
#  + tmmn_min_tdif + tmmx_max_tdif 
  + tmmn_mean_tdif + tmmx_mean_tdif
#  + pr_tdif
  + tc_median

  | sw(1,main_biome, code_state),
  
  
  panel.id = c("code_amc","year"),
  cluster = "code_amc"
  )

etable(
  ext_ols,
  fitstat = ~ n + f + ivf
  )
```

# PPM version

## PPM Database

```{r}
ch_ppm_amc <- cattle_heads_ppm |> 
  ########### get PPM data
  left_join(
    muni_to_amc |> select(-name_muni),
    by = join_by(code_muni)
  ) |> 
  ########### aggregate by AMC
  summarise(
    .by = c("code_amc", "year"),
    
    cattle_heads = sum(cattle_heads, na.rm = TRUE),
    main_biome = unique(main_biome)
  ) |> 
  mutate(
    year = as.numeric(year)
  )
```

```{r}
ext_ppm_complete <- transition_agg |> 
  ############# get transition probabilities
  select(
    code_amc,
    year = year_from,
    rho_1 = natural_pasture
  ) |> 
  mutate(
    rho_2 = lead(rho_1),
    .by = code_amc
  ) |> 
  ########### include ssiv
  left_join(
    ssiv |>  select(code_amc, area_amc, ssiv, year),
    
    by = c("code_amc", "year")
  ) |> 
  ############ join with PPM data
  left_join(
    ch_ppm_amc,
    
    by = c("code_amc", "year")
  ) |> 
  # calculate normalized head count (intensity)
  mutate(
    h = cattle_heads/area_amc
  ) |>
  ############# include controls
  left_join(
    tc_by_amc |> select(code_amc, tc_mean, tc_median),
    by = "code_amc"
  ) |>  
  left_join(
    si_by_amc |> select(code_amc, si_mean, si_median),
    by = "code_amc"
  ) |>
  # join with market access for 2010
  left_join(
    ma_long |> 
      filter(year_ma == 2010) |> 
      select(-year_ma, -year),
    
    by = "code_amc"
  ) |>
  ############ include land use
  left_join(
    land_cover_agg,
    
    by = c("code_amc", "year")
  )  |> 
  ############ include pasture quality
  left_join(
    past_qual,
    by = c("code_amc", "year")
  ) |> 
  ############ terraclimate controls
  left_join(
    terraclimate,
    
    by = c("code_amc", "year")
  )|> 
  ########### include carbon biomass
  left_join(
    biomass,
    by = "code_amc"
  ) |> 
  # calculate carbon density in CO2
  mutate(
    biomass_co2 = (biomass/2)*(44/12),
    biomass_density = biomass_co2/area_amc
  ) |> 
  ############# calculate regression variables
  # difference in cost factors
  mutate(
    .by = "code_amc",
    across(
      .cols = c(high_share, tmmn_min:tmmx_mean, pr),
      .fns = tdif,
      .names = "{.col}_tdif"
      )
  ) |> 
  mutate(
    .by = "code_amc",
    
    pr_lag = dplyr::lag(pr),
    
    y = log(rho_1/(1-rho_1)) - beta* log(rho_2) + beta*gamma,
    
    x2 = 0.45*(cattle_heads/area_amc)**2,
    
    x3 = 0.45*(cattle_heads/pasture)**2,
    
    year_tdif = (beta + (beta - 1) * year)
  ) 


ext_ppm = ext_ppm_complete |> 
  ############# remove probability 0 and 1 (impossible log odds)
  filter(
    rho_1 != 0 &
    rho_1 != 1 &
    rho_2 != 0 
  ) |> 
  filter(
    !is.na(x2),
    !is.na(high_share)
  )
```


## OLS with PPM

```{r}
ppm_ols <- feols(
  data = ext_ppm,
  y ~ x2
  + high_share_tdif
  + biomass_density
  + ma_norm
  + si_median
  + year_tdif
  + tmmn_min_tdif + tmmx_max_tdif 
  + tmmn_mean_tdif + tmmx_mean_tdif 
  + pr_tdif
  
  | sw(1, main_biome, code_state),
  
  
  panel.id = c("code_amc","year"),
  cluster = "code_amc",
  )


etable(
  ppm_ols,
  fitstat = ~ n + f + wf + r2)
```

## IV with PPM

```{r}
ppm_iv <- feols(
  data = ext_ppm,
  y ~ 
    x2
  + biomass_density
  + ma_norm
  + si_median
  + year_tdif
  + tmmn_min_tdif + tmmx_max_tdif 
  + tmmn_mean_tdif + tmmx_mean_tdif
  + pr_tdif
  + tc_median
 
  | sw(1, main_biome, code_state)
  | high_share_tdif ~ pdsi_min,
  
  
  panel.id = c("code_amc","year"),
  cluster = "code_amc"
  )

etable(
  ppm_iv, 
  stage = 2,
  fitstat = ~ n + f + f.p + ivf + ivf.p)
```

# Selected models

```{r}
######### Int margin - IV model with Biome FE
int_mod <- iv[[2]]

######### Ext margin - OLS model with Biome FE
ext_mod <- ext_iv[[2]]
```

# Counterfactuals

To calculate a counterfactual, I'll choose a pair of models of each margin. Then, I predict the int margin model with real data, and compare the prediction to when a I make a variation in the data.

I calculate the ext margin model for the predicted headcount and for the counterfactual. Probability for the year two-ahead remains the same because it is forward looking.

## CF database

I construct a database for the extensive margin, where I also get results from 2007 and 2018, using PPM data to expand the series one year ahead. This dataframe needs to be an intersection of `ext_data` and `int_data`, expanded one year ahead. Before creating the main dataframe, I create an identifier with the code_amc from the int_margin dataframe and the years extended by one. 

```{r}
int_data_identifier <- int_data |> 
  select(code_amc, year) |> 
  mutate(year_2 = year + 1) |> 
  pivot_longer(
    cols = c(year, year_2),
    names_to = NULL,
    values_to = "year"
  )
```


```{r}
ext_cf <- ext_data_complete |>
  # remove columns that will be changed
  select(
    - c(main_biome, cattle_heads)
  ) |>
  # join with ppm data
  left_join(
    ch_ppm_amc,
    by = c("code_amc", "year")
  ) |> 
  # calculate delta_cattle_heads and next year cattle_heads_big
  # also calculate the next period high_share
  mutate(
    .by = "code_amc",
    
    delta_cattle_heads = cattle_heads/lag(cattle_heads),
    
    cattle_heads_big = if_else(
      # if year after census
      year %in% c(2007, 2018),
      # use PPM ch growth
      lag(cattle_heads_big) * delta_cattle_heads,
      # else keep usual ch
      cattle_heads_big),
    
    high_share_2 = lead(high_share),
    .before = "high_share"
    ) |>
  # filter for census years and the following year
  filter(
    year %in% c(2006:2007, 2017:2018)
  ) |> 
  # remove impossible probabilities in both years and keep the intersection
  filter(
    (year %in% c(2006, 2017) & 
       rho_1 != 0 &
       rho_1 != 1 &
       rho_2 != 0 &
       rho_2 != 1 &
       rho_3 != 0) | 
      (year %in% c(2007, 2018) &
         rho_lag != 0 & 
         rho_lag != 1 &
         rho_1 != 0 & 
         rho_1 != 1 &
         rho_2 != 0)
  ) |> 
  # recalculate main variables
  mutate(
    h = cattle_heads_big/area_amc,
    x2 = 0.45*(h)**2,
    y = log(rho_1/(1-rho_1)) - beta* log(rho_2) + beta*gamma
  ) |> 
  # fill ma_norm
  group_by(
    code_amc
  ) |> 
  fill(
    ma_norm, 
    .direction = "down"
  ) |> 
  ungroup(
  ) |> 
  # intersect with the identifier from intensive margin data
  semi_join(
    int_data_identifier,
    by = c("code_amc", "year")
  ) 
```


## Results


```{r}
min_high_share <- 1

recovery_counterfactual(
  int_mod, 
  ext_mod, 
  int_data,
  ext_cf, 
  min_high_share,
  beta = beta
)
```


```{r}
x <- tibble(
  i = double(), 
  hat = double(),
  effective = double(),
  potential = double()
  )

for (i in seq(0, 1, 0.01)) {
  result <- recovery_counterfactual(
    int_mod, 
    ext_mod, 
    int_data,
    ext_cf, 
    min_high_share = i,
    beta = beta
    ) |>
    filter(
      type == "static"
    ) |>
    select(
      hat,
      effective,
      potential
    )
  
  x <- x |> 
    rows_append(
      tibble(i = i, result) 
    )
}

x |> 
  mutate(
    def_disincentive = potential - hat,
    def_incentive = effective - potential,
    def_net = hat - effective,
    
    def_disincentive_pc = def_disincentive/hat,
    def_incentive_pc = effective - potential,
    def_net_pc = hat - effective,
    
  )

```

```{r}
ggplot(x, aes(x = i, y = result)) +
  geom_line() +
  labs(x = "pasture quality", y = "deforestation") +
  theme_minimal()
```


## Carbon tax

```{r}
tax_counterfactual <- function(model, tax) {
  # Extract original coefficients
  coefs <- coef(model)
  
  # calculate alpha_p
  alpha_p = calculate_structural_params(int_mod, ext_mod)$Value[3]
  
  # Replace the coefficient of biomass_density with new_alpha_b
  coefs["biomass_density"] <- -tax * alpha_p
  
  # Extract the design matrix for the predictors used in the model
  design_matrix <- model.matrix(model)
  
  # Calculate the new predictions (excluding fixed effects)
  y_biomass <- as.vector(design_matrix %*% coefs)
  
  # Add the fixed effects back to the predictions
  fixed_effects <- predict(model, fixef = TRUE)$main_biome
  y_biomass <- y_biomass + fixed_effects
  
  # Return the predictions
  return(y_biomass)
}
```

Testing:

```{r}
ext_data |> 
  mutate(
    y_biomass = tax_counterfactual(ext_mod, tax = 3),
    y_hat = predict(ext_mod, newdata = ext_data)
  ) |> 
  select(
    code_amc, year, rho_1, rho_2, y_biomass, y_hat, natural
  ) |> 
  mutate(
    across(
      .cols = c(y_biomass, y_hat),
      .fns = ~ logit(.x - 0.9*gamma + 0.9*log(rho_2)),
      .names = "rho_{.col}"
    )
  ) |> 
  filter(
      year %in% c(2006, 2017)
    ) |> 
  summarise(
    real = sum(rho_1*natural),
    hat = sum(rho_y_hat*natural),
    biomass = sum(rho_y_biomass*natural)
  )


```

# Maps

```{r}
map_data <- amc_1991_2022 |> 
  select(-area_amc) |> 
  cross_join(
    tribble(~year, 2006, 2017)
  ) |> 
  right_join(
    ext_data,
    by = c("code_amc", "year")
  )
```

## Prices

```{r}
map_prices <- ggplot() +
  # Plot non-NA local_price values
  geom_sf(
    data = map_data,
    aes(fill = local_price),  # Automatically detects geometry from sf object
    color = NA
  ) +
  # Add outline
  geom_sf(
    data = brazil, 
    color = "lightgrey",
    fill = NA
  ) +
  # Create facets for different years
  facet_wrap(~ year, ncol = 2) +  
  # Apply the color scale
  scale_fill_viridis_c(
    option = "magma",
    direction = -1
  ) + 
  # Adjust themes for cleaner appearance
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = NA, color = NA),
    legend.key.width = unit(0.2, "cm"),
    legend.title = element_blank()
  ) +
  labs(
    title = "Local Prices by Year in Sample",
    subtitle = "Prices per cattle head in R$ of 2022"
  )


#ggsave("../Outputs/Graphics/map_prices.pdf", plot = map_prices, device = "pdf", width = 10, height = 6)
```


## Transitions

```{r}
map_transitions <- ggplot(map_data) +
  geom_sf(
    data = map_data,
    aes(fill = rho_1, geometry = geom), 
    color = NA
    ) +
  facet_wrap(~ year, ncol = 2) +  
  scale_fill_viridis_c(
    option = "rocket",
    direction = -1
    ) +
  geom_sf(
    data = brazil, 
    color = "lightgrey",
    fill = NA
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = NA, color = NA),
    legend.key.width = unit(0.2, "cm"),
    legend.title = element_blank()
    ) +
  labs(
    title = "Transition probabilities",
    subtitle = "Yearly conversion rate from natural vegetation to pasture"
    )

map_transitions
#ggsave("../Outputs/Graphics/map_transitions.pdf", plot = map_transitions, device = "pdf", width = 10, height = 6)
```

## Pasture quality

```{r}
map_quality <- ggplot(map_data) +
  geom_sf(
    aes(fill = low_share), 
    color = NA
    ) +
  facet_wrap(~ year, ncol = 2) +  
  scale_fill_viridis_c(
    option = "rocket",
    direction = -1
    ) +
  geom_sf(
    data = brazil, 
    color = "lightgrey",
    fill = NA
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = NA, color = NA),
    legend.key.width = unit(0.2, "cm"),
    legend.title = element_blank()
    ) +
  labs(
    title = "Pasture quality",
    subtitle = "Share of pastures with low vegetative vigour by year"
    )

map_quality
#ggsave("../Outputs/Graphics/map_quality.pdf", plot = map_quality, device = "pdf", width = 10, height = 6)
```

## Biomass density

```{r}
map_biomass <- map_data |> 
  filter(year == 2017) |>
  ggplot() +
  geom_sf(
    aes(fill = biomass_density), 
    color = NA
    ) +  
  scale_fill_viridis_c(
    direction = -1
    ) +
  geom_sf(
    data = brazil, 
    color = "lightgrey",
    fill = NA
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = NA, color = NA),
    legend.key.width = unit(0.2, "cm"),
    legend.title = element_blank()
    ) +
  labs(
    title = "Aboveground Biomass",
    subtitle = "Density of AGB in CO2-equivalent tons per hectare"
    )

ggsave("../Outputs/Graphics/map_biomass.pdf", plot = map_biomass, device = "pdf", width = 8, height = 8)
```


# Plots

## Cattle heads

```{r}
plot_ch <- ext_ppm |> 
  summarise(
    ch = sum(cattle_heads),
    .by = c(code_biome, main_biome, year)
  ) |> 
  mutate(
    Bioma = case_when(
      code_biome == 1 ~ "Amazônia",
      code_biome == 2 ~ "Caatinga",
      code_biome == 3 ~ "Cerrado",
      code_biome == 4 ~ "Mata Atlântica",
      code_biome == 5 ~ "Pampa",
      code_biome == 6 ~ "Pantanal")
  ) |> 
  ggplot() +
  # Line plot with color by biome
  geom_line(
    aes(x = year, y = ch, color = Bioma),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "Amazônia" = "#1b9e77", 
      "Caatinga" = "#ffbb78",
      "Cerrado" = "#d95f02",
      "Mata Antlântica" = "#66b3ff",
      "Pampa" = "#d62728",
      "Pantanal" = "#9467bd"
      ),
    name = "Main Biome"
  ) +
  # Labels and titles
  labs(
    title = "Cattle Heads Over Time by Main Biome",
    subtitle = "Regional distribution of cattle heads from 2000 to 2022",
    x = "Year",
    y = "Cattle Heads"
  ) +
  # Improved theme
  theme_minimal() +
  theme(
    axis.text = element_text(color = "black")
  )

plot_ch
#ggsave("../Outputs/Graphics/plot_ch.pdf", plot = plot_ch, device = "pdf", width = 10, height = 6)
```

## Pastures

```{r}
land_cover_agg |> 
  left_join(
    select(agg_census_data, c(code_amc, code_biome, main_biome)),
    by = "code_amc"
  ) |> 
  summarise(
    pasture = sum(pasture, na.rm = T),
    .by = c(code_biome, main_biome, year)
  ) |> 
  mutate(
    Bioma = case_when(
      code_biome == 1 ~ "Amazônia",
      code_biome == 2 ~ "Caatinga",
      code_biome == 3 ~ "Cerrado",
      code_biome == 4 ~ "Mata Atlântica",
      code_biome == 5 ~ "Pampa",
      code_biome == 6 ~ "Pantanal")
  ) |> 
  ggplot() +
  # Line plot with color by biome
  geom_line(
    aes(x = year, y = pasture, color = Bioma),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "Amazônia" = "#1b9e77", 
      "Caatinga" = "#ffbb78",
      "Cerrado" = "#d95f02",
      "Mata Antlântica" = "#66b3ff",
      "Pampa" = "#d62728",
      "Pantanal" = "#9467bd"
      ),
    name = "Main Biome"
  ) +
  # Labels and titles
  labs(
    title = "Pasture area Over Time by Main Biome",
    subtitle = "Regional distribution of pastures from 2001 to 2020",
    x = "Year",
    y = "Pasture area (ha)"
  ) +
  # Improved theme
  theme_minimal() +
  theme(
    axis.text = element_text(color = "black")
  )
```

# Notes

Exchange
2019	3.9445
2022	5.1642

IPCA
2019    5320.25
2022    6474.09

SCC (2019 US$)
66.00

Annuity/perpetuity equivalent
6.60 (2019 US$)
26.0337 (2019 R$)
31.67981 (2022 R$)

Alpha_p
0.0033579724

Result:
-0.1063799


# Regression tables

## Intensive margin

```{r}
get_f_stats <- function(model) {
  map(
    list(
      `F (2nd stage)` = fixest::fitstat(model, "f")$f$stat,
      `F (1st stage: local_price)` = fixest::fitstat(model, "ivf")$`ivf1::local_price`$stat,
      `F (1st stage: local_price_2)` = fixest::fitstat(model, "ivf")$`ivf1::local_price_2`$stat,
      `F (1st stage: high_share)` = fixest::fitstat(model, "ivf")$`ivf1::high_share`$stat),
    
    \(x) round(x, 4)
  )
}

# Rename coefficients
coef_rename <- c(
  "fit_local_price" = "$p_{mt}$",
  "fit_local_price_2" = "$p_{mt+1}$",
  "fit_high_share" = "Pasture Quality ($x_{mt+1}$)",
  "year" = "Year"
)

# Add model parameters as an extra column
model_parameters <- data.frame(
  "Parameters" = c(
  "$-\\dfrac{\\alpha_p}{\\delta \\beta}$", "",
  "$\\dfrac{\\alpha_p (1 + \\phi)}{\\delta}$", "",
  "$-\\dfrac{\\gamma_{pasture}}{\\delta}$", "",
  "$-\\dfrac{\\gamma_t}{\\delta}$")
)

# Add controls, fixed effects, and F-statistics as extra rows
extra_rows <- data.frame(
  rowname = c("Controls", 
              "Fixed Effects", 
              "F (2nd stage)", 
              "F (1st stage: $p_{mt}$)", 
              "F (1st stage: $p_{mt+1}$)", 
              "F (1st stage: Past. Qual.)", 
              "Clustered SE"),
  value = c(
    "Temp.; Past.Suit.; Mkt.Acc.", 
    "Biome", 
    get_f_stats(int_mod)[["F (2nd stage)"]], 
    get_f_stats(int_mod)[["F (1st stage: local_price)"]], 
    get_f_stats(int_mod)[["F (1st stage: local_price_2)"]], 
    get_f_stats(int_mod)[["F (1st stage: high_share)"]], 
    "Yes (Municipality)"),
  mod_par = ""
  )

# Name a model list dynamically 
header = paste0("\\toprule", 
                "$h_{mt+1}$")

model_list = setNames(list(int_mod), header)


# Create the table
modelsummary(
  model_list,
  coef_map = coef_rename,
  gof_map = "nobs",
  fmt = 4, 
  statistic = "{std.error}", 
  stars = c("***"=0.01, "**"=0.05, "*"=0.10), 
  add_rows = extra_rows,
  title = "Intensive Margin IV Regression Results\\label{tab:main_int}",
  notes = paste(
    "Standard errors clustered at the municipality level.",
    "Biome fixed effects.",
    "Controls: Pasture suitability, market access, 
      minimum, maximum, and mean temperature.",
    "Shift-share variables used as instruments for prices.",
    "Lagged precipitation used as instruments for pasture quality."
  ),
  add_columns = model_parameters,
  output = "tinytable",
  escape = FALSE,
  width = 1
  ) |>
  style_tt(
    tabularray_inner = "
      row{1} = {valign = m},
      row{2,4,6,8} = {abovesep = 5pt, belowsep = -7pt},
      column{3} = {valign = b}
      "
    ) |> 
  save_tt(
    output = "../Outputs/Tables/main_int_table.tex",
    overwrite = T
  )

remove(get_f_stats, coef_rename, model_parameters, extra_rows)
```


## Extensive margin

```{r}
get_f_stats <- function(model) {
  map(
    list(
      `F (2nd stage)` = fixest::fitstat(model, "f")$f$stat,
      `F (1st stage: high_share_tdif)` = fixest::fitstat(model, "ivf")$`ivf1::high_share_tdif`$stat),
    
    \(x) round(x, 4)
    )
}

# Rename coefficients
coef_rename <- c(
  "x2" = "$\\frac{\\beta}{2}(h_{mt+1})^2$",
  "fit_high_share_tdif" = "Pasture Quality ($\\beta x_{mt+1} - x_{mt})$",
  "biomass_density" = "$b_m$",
  "year_tdif" = "$(\\beta + (\\beta - 1) t)$"
)

# Add model parameters as an extra column
model_parameters <- data.frame(
  "Parameters" = c(
  "$\\delta$", "",
  "$\\gamma_{pasture}^e$", "",
  "$-\\alpha_b$", "",
  "$\\gamma_t^e$")
)

# Add controls, and F-statistics as extra rows
extra_rows <- data.frame(
  rowname = c("Controls", 
              "F (2nd stage)", 
              "F (1st stage: Past. Qual.)",
              "Clustered SE"),
  value = c(
    "Temp.; Past.Suit.; Mkt.Acc.; Precip.",
    get_f_stats(ext_mod)[["F (2nd stage)"]],
    get_f_stats(ext_mod)[["F (1st stage: high_share_tdif)"]], 
    "Yes (Municipality)"),
  mod_par = ""
  )

# Name a model list dynamically 
header = paste0(
  "\\toprule",
  "$ \\log \\left( \\frac{\\rho_{mt}}{1 - \\rho_{mt}} \\right)
    -\\beta \\log ( \\rho_{mt+1} ) + \\beta \\gamma $") 

model_list = setNames(list(ext_mod), header)

# Create the table
modelsummary(
  model_list,
  coef_map = coef_rename,
  gof_map = "nobs",
  fmt = 4, 
  statistic = "({std.error})", 
  stars = c("***"=0.01, "**"=0.05, "*"=0.10), 
  add_rows = extra_rows,
  title = "Extensive Margin IV Regression Results\\label{tab:main_ext}",
  notes = paste(
    "Standard errors clustered at the municipality level.",
    "Controls: Pasture suitability, market access, precipitation,
      minimum, maximum, and mean temperature.", 
    "All time varying controls have been calculated as an inter-temporal 
      difference of the form $\\beta x_{mt+1}-x_{mt}$.",
    "Precipitation in levels used as an instrument for the intertemporal difference in pasture quality."
  ),
  add_columns = model_parameters,
  output = "tinytable",
  escape = FALSE,
  width = 1
    ) |>
  style_tt(
    tabularray_inner = "
      rowsep = 4pt,
      row{1} = {valign = m},
      row{2,4,6,8} = {abovesep = 5pt, belowsep = -5pt}
      "
    ) |> 
  save_tt(
    output = "../Outputs/Tables/main_ext_table.tex",
    overwrite = T
  )

remove(get_f_stats, coef_rename, model_parameters, extra_rows, header, model_list)
```


## Structural parameters

In this section, I will use the preferred empirical exercise to recover the structural parameters that arise from the model.I first define a function to calculate the structural parameters, then run and export as latex table.

```{r} 
calculate_structural_params(int_mod, ext_mod) |> 
  kbl(
    digits = c(4,4,2),
    
    # configure header
    col.names = c(
      paste0("\\hline", "\\addlinespace ",
        "Parameter"),
      "Value", 
      paste0("Scaled by $\\alpha_p$ (R\\$)",
             "\\vspace{0.4em}")
      ),
    
    booktabs = T,
    label = "tab:str_param",
    caption = "Structural Parameters",
    format = "latex",
    escape = FALSE,
    linesep = "\\addlinespace"
  ) |>
  kable_styling(
    full_width = T,
    htmltable_class =  "lightable-classic-2"
  ) |> 
  pack_rows("Intensive margin cost factors", 5, 12, latex_gap_space = "1em") |> 
  pack_rows("Extensive margin cost factors", 13, 20, latex_gap_space = "1em") |> 
  save_kable("../Outputs/Tables/str_param_table.tex")
```

## Extra tables

### First stage results

```{r}
coef_rename <- c(
  local_price = "$p_{mt}$",
  local_price_2 = "$p_{mt+1}$",
  high_share = "Pasture Quality ($x_{mt+1}$)",
  high_share_tdif = "Pasture Quality ($\\beta x_{mt+1} - x_{mt}$)",
  year = "Year",
  year_tdif = "$(\\beta + (\\beta - 1) t)$",
  ssiv = "$ssiv_{mt}$",
  ssiv_2 = "$ssiv_{mt+1}$",
  pr = "Lag Precip",
  code_amc = "Municipality",
  main_biome = "Biome",
  biomass_density = "$b_m$",
  mata_atlantica = "mata atlantica",
  y = "$ \\log \\left( \\frac{\\rho_{mt}}{1 - \\rho_{mt}} \\right) -\\beta \\log ( \\rho_{mt+1} ) + \\beta \\gamma $ \\vspace{1ex}",
  x2 = "$\\frac{\\beta}{2}(h_{mt+1})^2$",
  h = "$h_{mt+1}$"
  )

etable(
    int_mod,
    stage = 1,
    digits = 4,
    fitstat = ~ n + f + ivf,
    group = list(
      Temperature = c("tmmn_min", "tmmx_max", "tmmn_mean", "tmmx_mean"),
      `Past. Suit.` = "si_median",
      `Mkt. Acc.` = "ma_norm"
      ),
    dict = coef_rename,
    # output
    file = "../Outputs/Tables/int_first_stage.tex",
    replace = T,
    # latex configurations
    label = "tab:int_first_stage",
    tabular = "X",
    style.tex = style.tex(
      model.title = "",
      yesNo = "$\\checkmark$",
      fontsize = "normalsize",
      model.format = "\\hspace{1em}"
      ),
    title = "Intensive margin first stage results"
    )
```


### Fixed efects intensive margin

```{r}
etable(
    ols[[4]],
    stage = 2,
    digits = 4,
    fitstat = ~ n + f,
    group = list(
      Temperature = c("tmmn_min", "tmmx_max", "tmmn_mean", "tmmx_mean"),
      `Past. Suit.` = "si_median",
      `Mkt. Acc.` = "ma_norm"
      ),
    dict = coef_rename,
    # output
    file = "../Outputs/Tables/int_fe.tex",
    replace = T,
    # latex configurations
    label = "tab:int_fe",
    tabular = "X",
    style.tex = style.tex(
      model.title = "",
      yesNo = c("$\\checkmark$", ""),
      fontsize = "normalsize",
      model.format = "\\hspace{1em}"
      ),
    title = "Intensive margin FE regression results"
    )
```

### PPM data for extensive margin

```{r}
etable(
  list(
    OLS = ppm_ols[[2]], 
    IV = ppm_iv[[2]]
    ),
  fitstat = ~ n + f,
  digits = 4,
  group = list(
      Temperature = c("tmmn_min", "tmmx_max", "tmmn_mean", "tmmx_mean"),
      `Past. Suit.` = "si_median",
      `Mkt. Acc.` = "ma_norm",
      Precipitation = "pr_tdif"
      ),
  dict = coef_rename,
  # output
  file = "../Outputs/Tables/ext_ppm.tex",
  replace = T,
  
  # latex configurations
  label = "tab:ext_ppm",
  tabular = "X",
  style.tex = style.tex(
    model.title = "",
    yesNo = "$\\checkmark$",
    fontsize = "normalsize",
    model.format = "\\hspace{1em}"
    ),
  title = "Extensive margin regression with survey data",
  headers = c("OLS", "IV")
  )
```
