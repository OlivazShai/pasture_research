---
title: "Data Unification"
author: "Shai Vaz"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(knitr.kable.NA = '')
```

```{r, include=FALSE}
# Table
library(kableExtra)

# Graphics
library(ggplot2)
library(ggpattern)

# Geographic
library(sf)

# Econometrics
library(fixest)
library(ivreg)
library(stats)
library(modelsummary)

# Data Wrangling
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(readxl)
library(forcats)
library(purrr)

# Personal functions
source("../Functions/bulk_rds.R")
```

# Importing files

```{r}
bulk_read_rds(
  # geographic
  muni_to_amc,
  amc_1991_2022,
  brazil,
  # prices
  national_prices,
  cattle_prices_cepea_in_census_years,
  ipca_census_years,
  # census data
  agg_census_data,
  # survey data
  cattle_heads_ppm,
  # instruments
  ssiv,
  # controls
  tc_by_amc,
  ma_long,
  si_by_amc,
  # mapbiomas
  land_cover_agg,
  transition_agg,
  past_qual,
  # carbon biomass
  biomass
  )
```

Read terraclimate climatic controls. 

```{r}
terraclimate <- read_csv(
  "../Variables/terraclimate.csv", 
  col_types = "cnnnnnnnn")
```

# Joining database

```{r}
int_data <- left_join(
  # first I join shifters with prices
  # then I extract data from t+1
  ssiv |> 
    select(code_amc, year, area_amc, ssiv),
  
  cattle_prices_cepea_in_census_years,
  
  by = c("year" = "census_year")
  ) |> 
  ########## get next period prices and shifters
  mutate(
    mean_price_2 = if_else(
      year == 2006 | year == 2017,
      lead(mean_price),
      NA),
    
    mean_nominal_price_2 = if_else(
      year == 2006 | year == 2017,
      lead(mean_nominal_price),
      NA),
    
    ssiv_2 = if_else(
      year == 2006 | year == 2017,
      lead(ssiv),
      NA)
  ) |>
  ############ join with census data
  right_join(
    agg_census_data,
    
    by = c("code_amc", "year")
  ) |>
    # drop observations without cattle sales
  filter(
    ! is.na(av_price_slaughter)
  ) |> 
    # calculate normalized head count (intensity)
  mutate(
    h = cattle_heads_big/area_amc
  ) |> 
  ############ join with inflation
  left_join(
    ipca_census_years,
    
    by = c("year" = "census_year")
  ) |> 
  ############ deflate and project ahead local prices
             # using IPCA ratio (index_2022/index)
  mutate(
    local_price = av_price_slaughter * (index_2022/index)
                  *1000,
    
    local_price_2 = av_price_slaughter *(index_2022/index)
                    *(mean_price_2/mean_price)*1000,
  ) |> 
  ############# include controls
  left_join(
    tc_by_amc,
    by = "code_amc"
  ) |> 
  left_join(
    ma_long,
    by = c("code_amc", "year")
  ) |> 
  left_join(
    si_by_amc,
    by = "code_amc"
  ) |> 
  ############ include land use
  left_join(
    land_cover_agg,
    
    by = c("code_amc", "year")
  ) |> 
              # calculate pasture share (in t and only in 2006)
  mutate(
    past_share = if_else(is.na(pasture), 0, pasture/area_amc),
    
    pasture_2006 = if_else(year == 2006, pasture, lag(pasture)),
    
    past_share_2006 = if_else(is.na(pasture_2006), 0, pasture_2006/area_amc)
  ) |> 
  ############ include pasture quality
  left_join(
    past_qual |> 
            ####### testing lead high share
            mutate( 
              .by = code_amc,
              high_share = dplyr::lead(high_share)
            ),
    by = c("code_amc", "year")
  ) |>
            # filter out one NA on total pastures
            # only case is Afuá-PA (in Marajó island)
  filter(
    ! is.na(total)
  ) |> 
  ########### include carbon biomass
  left_join(
    biomass,
    by = "code_amc"
  ) |> 
            # calculate carbon density in CO2
            # uses atomic weight of C (12) and CO2 (44)
            # and the fact that biomass is about 50% C
  mutate(
    biomass_co2 = (biomass/2)*(44/12),
    biomass_density = biomass_co2/area_amc
  ) |> 
  ############ terreclimate controls
  left_join(
    terraclimate,
    
    by = c("code_amc", "year")
  )
```

# Intensive margin

## IV 

```{r}
iv <- feols(
  data = int_data,
  h ~
    ma_norm
  + si_median
  + year
  + tmmn_min + tmmx_max
  + tmmn_mean + tmmx_mean

  | sw(1,main_biome, code_state)
  
  | local_price + local_price_2 + high_share ~ ssiv + ssiv_2 + pr,
  
  panel.id = c("code_amc","year"),
  cluster = "code_amc"
  )

etable(
  iv, 
  stage=2, 
  digits = 4,
  fitstat = ~ n + f + ivf)
```

Etable with phi:

```{r}
phi_iv = function(x) {
  # Extract coefficients
  coefs <- stats::coef(x)
  
  # Calculate phi
  phi <- - coefs["fit_local_price_2"] / (0.9 * coefs["fit_local_price"]) - 1
  
  # Return phi value
  return(phi)
}

extralines_register("phi_iv", phi_iv, "phi")


etable(
  iv, 
  stage = 2, 
  digits = 4,
  fitstat = ~ n + f + ivf,
  extralines = ~ phi_iv
)

```


## OLS 

```{r}
ols <- feols(
  data = int_data,
  h ~
    local_price
  + local_price_2
  + high_share
  + ma_norm
  + si_median
#  + past_share_2006
#  + biomass_density
#  + area_amc
  + year
  + tmmn_min
  + tmmx_max 
  + high_share
  
  | sw(1,main_biome,code_state, code_amc),
  panel.id = c("code_amc","year"),
  cluster = "code_amc"
  )

etable(
  ols, 
  stage=2, 
  digits = 5,
  fitstat = ~ n + f + ivf
  )
```


```{r}
phi_ols = function(x) {
  # Extract coefficients
  coefs <- stats::coef(x)
  
  # Calculate phi
  phi <- ( - coefs["local_price_2"] ) / (0.9 * coefs["local_price"]) - 1
  
  # Return phi value
  return(phi)
}

extralines_register("phi_ols", phi_ols, "phi")

etable(
  ols, 
  stage = 2, 
  digits = 4,
  fitstat = ~ n + f + wf + r2 + wr2 + ar2,
  extralines = ~ phi_ols
)

```

# Diagnostics (one iv)

```{r, eval=FALSE}
a <- joined_data |> 
  mutate(
    fe = as_factor(code_amc),
    fe_2 = as_factor(main_biome)
  ) |> 
  drop_na() |> 
  filter(
    cattle_heads_big != 0
  )
```

```{r, eval=FALSE}
first_stage1 <- lm(local_price ~ ssiv, data = a)
first_stage2 <- lm(local_price_2 ~ ssiv_2, data = a)

# Extract predicted values
a$local_price_hat <- predict(first_stage1)
a$local_price_2_hat <- predict(first_stage2)
```

```{r, eval=FALSE}
iv_model <- ivreg(
  cattle_heads_big ~ local_price_hat + local_price_2_hat:fe_2 + fe_2, 
  data = a
)


summary(iv_model)
```

# Extensive margin

Import Euler-Mascheroni constant:

```{r}
gamma = -digamma(1)
```

Now, I join the transition probabilities with my intensive margin data and calculate the new regression variables. 

```{r}
ext_data <- transition_agg |> 
  ############# get transition probabilities
  select(
    code_amc,
    year = year_from,
    rho_1 = natural_pasture
  ) |> 
  mutate(
    rho_2 = lead(rho_1),
    .by = code_amc
  ) |> 
  ############# join with intensive margin data
  right_join(
    int_data,
    by = c("code_amc", "year")
  ) |>
  ############# remove probability 0 and 1 (impossible log odds)
  filter(
    rho_1 != 0 &
    rho_1 != 1 &
    rho_2 != 0 
  ) |> 
  ############# calculate regression variables 
  mutate(
    y = log(rho_1/(1-rho_1)) - 0.9* log(rho_2) + 0.9*gamma,
    
    x1 = 0.45*(cattle_heads_big**2),
    
    x2 = 0.45*(h)**2,
    
    x3 = 0.45*(cattle_heads_big/pasture)**2,
    
    x4 = 0.45*(cattle_heads/area_amc)**2
  ) |> 
  #################
  # test with h_hat
  #################
  left_join(
    int_data |> 
      mutate(h_hat = predict(iv[[2]])) |> 
      select(year, code_amc, h_hat),
    
    by = c("code_amc", "year")
  ) |> 
  mutate(
    x5 = 0.45*(h_hat)**2
  ) |> 
  ##############
  # correct high_share back to current time
  #############
  mutate(
    high_share = NULL
  ) |> 
  left_join(
    past_qual |> select(high_share, code_amc, year),
    by = c("code_amc", "year")
  )
```


## OLS with Census

```{r}
ext_ols <- feols(
  data = ext_data,
  y ~ x2
  + high_share
  + ma_norm
  + si_median
  + biomass_density
  + year
  + tmmn_min + tmmx_max 
  + tmmn_mean + tmmx_mean
#  + pr
  
  | sw(1,main_biome, code_state),
  cluster = "code_amc"
  )

etable(
  ext_ols,
  fitstat = ~ n + f + wf + r2 + ar2 + wr2)
```

## Varying slope for biomass valuation

```{r}
ext_vary_biomass <- feols(
  data = ext_data,
  y ~ x2
  + high_share
  + ma_norm
  + si_median
  + biomass_density:main_biome
  + year
  + tmmn_min + tmmx_max 
  + tmmn_mean + tmmx_mean
#  + pr
  
  | sw(1,main_biome, code_state),
  cluster = "code_amc"
  )

etable(
  ext_vary_biomass,
  fitstat = ~ n + f + wf + r2 + ar2 + wr2)

```

## IV with census

```{r}
ext_iv <- feols(
  data = ext_data,
  y ~ x2
#  + high_share
  + ma_norm
  + si_median
  + biomass_density
  + year 
  + tmmn_min + tmmx_max
  #+ tmmn_mean + tmmx_mean
  
  | sw(1, main_biome, code_state)
  | high_share ~ pr,
  cluster = "code_amc"
  ) 

etable(
  ext_iv,
  fitstat = ~ n + f + ivf
  )
```

# PPM version


```{r}
ext_ppm <- cattle_heads_ppm |> 
  ########### get PPM data
  left_join(
    muni_to_amc |> select(-name_muni),
    by = join_by(code_muni)
  ) |> 
  ########### aggregate by AMC
  summarise(
    .by = c("code_amc", "year"),
    
    cattle_heads = sum(cattle_heads, na.rm = TRUE),
    main_biome = unique(main_biome),
    code_biome = unique(code_biome)
  ) |> 
  ########### join with market access for 2000
  left_join(
    ma_long |> 
      filter(year_ma == 2000) |> 
      select(-year_ma, -year),
    
    by = "code_amc"
  ) |> 
  mutate(
    year = as.numeric(year)
  ) |> 
  ############# join with transition probabilities
  left_join(
    by = join_by("code_amc", "year"), 
    
    transition_agg |>
      select(
          code_amc,
          year = year_from,
          rho_1 = natural_pasture
      ) |> 
      mutate(
        rho_2 = lead(rho_1),
        .by = code_amc)
  ) |> 
  
  ############ join with shift share 
  left_join(
    by = c("code_amc", "year"),
    
    ssiv |> 
      select(
      year, code_amc, psi, area_amc, ssiv  
      ) |> 
      mutate(
        ssiv_2 = lead(ssiv),
        ssiv_lag = lag(ssiv),
        .by = "code_amc"
      )
  ) |> 
  ########## filter for years and probabilities without NA
  filter(
    year > 2001,
    year < 2021,
    
    rho_1 != 0,
    rho_1 != 1,
    rho_2 != 0
  ) |> 
  ########## join with pasture quality
  left_join(
    past_qual,
    by = c("code_amc", "year")
  ) |> 
  filter(
    !is.na(total)
  ) |> 
  ########## calculate regression variables
  mutate(
    y = log(rho_1/(1-rho_1)) - 0.9* log(rho_2) + 0.9*gamma,
    
    x1 = 0.45*(cattle_heads**2),
    
    x2 = 0.45*(cattle_heads/area_amc)**2,
    
    x3 = 0.45*(cattle_heads/total)**2
  ) |> 
  ########## join with biomass data
  left_join(
    biomass,
    by = "code_amc"
  ) |> 
  # calculate carbon density in CO2
  # uses atomic weight of C (12) and CO2 (44)
  # and the fact that biomass is about 50% C
  mutate(
    biomass_co2 = (biomass/2)*(44/12),
    biomass_density = biomass_co2/area_amc
  ) |> 
  ########## terraclimate controls
  left_join(
    terraclimate |> 
      mutate(
        .by = code_amc,
        pr_lag = dplyr::lag(pr)
      ),
    
    by = c("code_amc", "year")
  ) |> 
  ############ include natural vegetation
  left_join(
    land_cover_agg |> 
      select(
        code_amc, year, natural
      ),
    
    by = c("code_amc", "year")
  )
```

## OLS with PPM

```{r}
ppm_ols <- feols(
  data = ext_ppm,
  y ~ x2
  + ma_norm
  + high_share
  + year
  + biomass_density
  + tmmn_min + tmmx_max 
  + tmmn_mean + tmmx_mean 
  + pr
  
  
  
  | sw(1, main_biome, code_state),
  cluster = "code_amc"
  )


etable(
  ppm_ols,
  fitstat = ~ n + f + f.p + wf + wf.p + r2 + ar2 + wr2)
```

## IV with PPM

```{r}
ppm_iv <- feols(
  data = ext_ppm,
  y ~ x2
  + ma_norm
  + biomass_density
  + year
#  + area_amc
#  + tmmn_min + tmmx_max
  + tmmn_mean + tmmx_mean

  | sw(1, main_biome, code_state)
  | high_share ~ pr_lag,
  cluster = "code_amc"
  )

etable(
  ppm_iv, 
  stage = 2,
  fitstat = ~ n + f + f.p + ivf + ivf.p)
```

# Counterfactuals

To calculate a counterfactual, I'll choose a pair of models of each margin. Then, I predict the int margin model with real data, and compare the prediction to when a I make a variation in the data.

I calculate the ext margin model for the predicted headcount and for the counterfactual. Probability for the following year remains the same because it is forward looking.

## Selected models

```{r}
######### Int margin - IV model with Biome FE
int_mod <- iv[[2]]

######### Ext margin - OLS model with Biome FE
ext_mod <- ext_ols[[2]]
```


## Intensive margin 

```{r}


########## Counterfactual data

# increase 10% prices
p_change = 0.1

int_cf_data_p <- int_data |> 
  mutate(
    local_price = local_price * (1+p_change),
    local_price_2 = local_price_2 * (1+p_change)
    )

# increase pasture quality to at least 90%
min_high_share = 0.85

int_cf_data_deg <- int_data |> 
  mutate(
    high_share = if_else(
      high_share > min_high_share, 
      high_share, 
      min_high_share),
  )

# join counterfactuals with dataframe 
int_cf <- int_data |> 
  mutate(
    h_hat = predict(int_mod),
    
    h_p = predict(int_mod, newdata = int_cf_data_p),
    
    h_deg = predict(int_mod, newdata = int_cf_data_deg)
  )

######### summarise variations
int_cf_biome <- int_cf |> 
  mutate(
    H = cattle_heads_big,
    H_hat = h_hat*area_amc,
    H_p = h_p*area_amc,
    H_deg = h_deg*area_amc
  ) |> 
  summarise(
    .by = "main_biome",
    real = sum(H),
    expected = sum(H_hat),
    cf_p = sum(H_p),
    elast_p = (cf_p - expected)/expected * (1/p_change),
    cf_deg = sum(H_deg),
  #  elast_deg = (cf_deg - expected)/expected * (-1/deg_change)
  )

int_cf_total <- int_cf |> 
  mutate(
    H = cattle_heads_big,
    H_hat = h_hat*area_amc,
    H_p = h_p*area_amc,
    H_deg = h_deg*area_amc
  ) |> 
  summarise(
    main_biome = "Total",
    real = sum(H),
    expected = sum(H_hat),
    cf_p = sum(H_p),
    elast_p = (cf_p - expected)/expected * (1/p_change),
    cf_deg = sum(H_deg),
  #  elast_deg = (cf_deg - expected)/expected * (-1/deg_change)
  )

# int_cf_latex <- 
  
bind_rows(
  int_cf_biome,
  int_cf_total
  ) |> 
  knitr::kable(
    digits = 3,
    caption = "Intensive margin counterfactuals"
    #,
    #format = "latex"
  )

# cat(int_cf_latex)
```

## Extensive Margin

```{r}
########## Counterfactual data

# estimated
ext_cf_data_hat <- ext_data |> 
  left_join(
    int_cf |> select(code_amc, year, h_p, h_deg),
    
    by = c("code_amc", "year")
  ) |> 
  mutate(
    x2 = 0.45*(h_hat)**2
  )

# price change
ext_cf_data_p <- ext_data |> 
  left_join(
    int_cf |> select(code_amc, year, h_hat, h_p, h_deg),
    
    by = c("code_amc", "year")
  ) |> 
  mutate(
    x2 = 0.45*(h_p)**2
  )

# degradation
ext_cf_data_deg <- ext_data |> 
  left_join(
    int_cf |> select(code_amc, year, h_hat, h_p, h_deg),
    
    by = c("code_amc", "year")
  ) |> 
  mutate(
    x2 = 0.45*(h_deg)**2,
    high_share = if_else(
      high_share > min_high_share, 
      high_share, 
      min_high_share),
  )

# join counterfactuals with dataframe 
ext_cf <- ext_data |> 
  mutate(
    y_hat = predict(ext_mod, newdata = ext_cf_data_hat),
    
    y_p = predict(ext_mod, newdata = ext_cf_data_p),
    
    y_deg = predict(ext_mod, newdata = ext_cf_data_deg)
  )

########## calculate new probabilities

logit = \(x) exp(x)/(1+exp(x))

ext_cf_biome <- ext_cf |> 
  mutate(
    rho_hat = logit(
      y_hat + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_p = logit(
      y_p + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_deg = logit(
      y_deg + 0.9*log(rho_2) - 0.9*gamma
      )
  ) |> 
  summarise(
    .by = "main_biome",
    real = sum(rho_1*natural),
    expected = sum(rho_hat*natural),
    cf_p = sum(rho_p*natural),
    elast_p = (cf_p - expected)/expected * (1/p_change),
    cf_deg = sum(rho_deg*natural),
#    elast_deg = (cf_p - expected)/expected * (-1/deg_change)
  )

ext_cf_year <- ext_cf |> 
  mutate(
    rho_hat = logit(
      y_hat + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_p = logit(
      y_p + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_deg = logit(
      y_deg + 0.9*log(rho_2) - 0.9*gamma
      )
  ) |> 
  summarise(
    .by = "year",,
    real = sum(rho_1*natural),
    expected = sum(rho_hat*natural),
    cf_p = sum(rho_p*natural),
    elast_p = (cf_p - expected)/expected * (1/p_change),
    cf_deg = sum(rho_deg*natural),
#    elast_deg = (cf_p - expected)/expected * (-1/deg_change)
  ) |> 
  mutate(
    main_biome = as.character(year)
  )

ext_cf_total <- ext_cf |> 
  mutate(
    rho_hat = logit(
      y_hat + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_p = logit(
      y_p + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_deg = logit(
      y_deg + 0.9*log(rho_2) - 0.9*gamma
      )
  ) |> 
  summarise(
    main_biome = "Total",
    real = sum(rho_1*natural),
    expected = sum(rho_hat*natural),
    cf_p = sum(rho_p*natural),
    elast_p = (cf_p - expected)/expected * (1/p_change),
    cf_deg = sum(rho_deg*natural),
#    elast_deg = (cf_p - expected)/expected * (-1/deg_change)
  )

# ext_cf_latex <- 

bind_rows(
  ext_cf_biome,
  ext_cf_year,
  ext_cf_total
  ) |> 
  knitr::kable(
    digits = 3,
    caption = "Extensive margin counterfactuals"
  #  ,
  #  format = "latex"
  )

# cat(ext_cf_latex)

```

## PPM

```{r}
ext_ppm_mod <- ppm_ols[[2]]

########## Counterfactual data

# estimated
ext_ppm_cf_data_hat <- ext_ppm |>
  filter(
    year == 2006 | year == 2017
  ) |> 
  left_join(
    int_cf |> select(code_amc, year, h_hat, h_deg),
    
    by = c("code_amc", "year")
  ) |> 
  mutate(
    x2 = 0.45*(h_hat)**2
  )

# degradation
ext_ppm_cf_data_deg <- ext_ppm_cf_data_hat |> 
  mutate(
    x2 = 0.45*(h_deg)**2,
    
    high_share = if_else(
      high_share > min_high_share, 
      high_share, 
      min_high_share),
  )

# join counterfactuals with dataframe 
ext_ppm_cf <- ext_ppm_cf_data_hat |> 
  mutate(
    y_hat = predict(ext_ppm_mod, newdata = ext_ppm_cf_data_hat),
    
    y_deg = predict(ext_ppm_mod, newdata = ext_ppm_cf_data_deg)
  )

########## calculate new probabilities

logit = \(x) exp(x)/(1+exp(x))

ext_ppm_cf_biome <- ext_ppm_cf |> 
  mutate(
    rho_hat = logit(
      y_hat + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_deg = logit(
      y_deg + 0.9*log(rho_2) - 0.9*gamma
      )
  ) |> 
  summarise(
    .by = "main_biome",
    real = sum(rho_1*natural, na.rm = T),
    expected = sum(rho_hat*natural, na.rm = T),
#    cf_p = sum(rho_p*natural),
#    elast_p = (cf_p - expected)/expected * (1/p_change),
    cf_deg = sum(rho_deg*natural, na.rm = T),
#    elast_deg = (cf_p - expected)/expected * (-1/deg_change)
  )

ext_ppm_cf_year <- ext_ppm_cf |> 
  mutate(
    rho_hat = logit(
      y_hat + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_deg = logit(
      y_deg + 0.9*log(rho_2) - 0.9*gamma
      )
  ) |> 
  summarise(
    .by = "year",,
    real = sum(rho_1*natural, na.rm = T),
    expected = sum(rho_hat*natural, na.rm = T),
#    cf_p = sum(rho_p*natural),
#    elast_p = (cf_p - expected)/expected * (1/p_change),
    cf_deg = sum(rho_deg*natural, na.rm = T),
#    elast_deg = (cf_p - expected)/expected * (-1/deg_change)
  ) |> 
  mutate(
    main_biome = as.character(year)
  )

ext_ppm_cf_total <- ext_ppm_cf |> 
  mutate(
    rho_hat = logit(
      y_hat + 0.9*log(rho_2) - 0.9*gamma
      ),
    
    rho_deg = logit(
      y_deg + 0.9*log(rho_2) - 0.9*gamma
      )
  ) |> 
  summarise(
    main_biome = "Total",
    real = sum(rho_1*natural, na.rm = T),
    expected = sum(rho_hat*natural, na.rm = T),
#    cf_p = sum(rho_p*natural),
#    elast_p = (cf_p - expected)/expected * (1/p_change),
    cf_deg = sum(rho_deg*natural, na.rm = T),
#    elast_deg = (cf_p - expected)/expected * (-1/deg_change)
  )

# ext_cf_latex <- 

bind_rows(
  ext_ppm_cf_biome,
  ext_ppm_cf_year,
  ext_ppm_cf_total
  ) |> 
  knitr::kable(
    digits = 3,
    caption = "Extensive margin counterfactuals"
  #  ,
  #  format = "latex"
  )

# cat(ext_cf_latex)

```


# Etable Tables

## Int

```{r}
etable(
    ols,
    stage=2, 
    digits = 4,
    fitstat = ~ n + f + wf + r2 + wr2 + ar2,
    extralines = ~phi_ols,
    tex = T,
    drop = c("ma_norm", "^si", "area_amc", "past_share", "biomass"),
    style.tex = style.tex("aer")
    )
```


```{r}
etable(
    iv,
    stage = 2,
    digits = 4,
    fitstat = ~ n + f + ivf,
    extralines = ~phi_iv,
    tex = T,
    drop = c("ma_norm", "^si", "area_amc", "past_share", "biomass"),
    style.tex = style.tex("aer")
    )
```

## Ext

```{r}
etable(
    ext_ols,
    stage=2, 
    digits = 4,
    fitstat = ~ n + f + wf + r2 + wr2 + ar2,
    tex = T,
    drop = c("ma_norm", "^si", "area_amc", "past_share"),
    style.tex = style.tex("aer")
    )
```


```{r}
etable(
    ext_iv,
    stage = 2,
    digits = 4,
    fitstat = ~ n + f + ivf,
    tex = T,
    drop = c("ma_norm", "^si", "area_amc", "past_share"),
    style.tex = style.tex("aer")
    )
```

## PPM

```{r}
etable(
    ppm_ols,
    stage=2, 
    digits = 4,
    fitstat = ~ n + f + wf + r2 + wr2 + ar2,
    tex = T,
    drop = c("ma_norm", "^si", "area_amc", "past_share"),
    style.tex = style.tex("aer")
    )
```


```{r}
etable(
    ppm_iv,
    stage = 2,
    digits = 4,
    fitstat = ~ n + f + ivf,
    tex = T,
    drop = c("ma_norm", "^si", "area_amc", "past_share"),
    style.tex = style.tex("aer")
    )
```

# Maps

```{r}
map_data <- amc_1991_2022 |> 
  select(-area_amc) |> 
  cross_join(
    tribble(~year, 2006, 2017)
  ) |> 
  right_join(
    ext_data,
    by = c("code_amc", "year")
  )
```

## Prices

```{r}
map_prices <- ggplot() +
  # Plot non-NA local_price values
  geom_sf(
    data = map_data,
    aes(fill = local_price),  # Automatically detects geometry from sf object
    color = NA
  ) +
  # Add outline
  geom_sf(
    data = brazil, 
    color = "lightgrey",
    fill = NA
  ) +
  # Create facets for different years
  facet_wrap(~ year, ncol = 2) +  
  # Apply the color scale
  scale_fill_viridis_c(
    option = "magma",
    direction = -1
  ) + 
  # Adjust themes for cleaner appearance
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = NA, color = NA),
    legend.key.width = unit(0.2, "cm"),
    legend.title = element_blank()
  ) +
  labs(
    title = "Local Prices by Year in Sample",
    subtitle = "Prices per cattle head in R$ of 2022"
  )


ggsave("../Outputs/Graphics/map_prices.pdf", plot = map_prices, device = "pdf", width = 10, height = 6)
```

## Transitions

```{r}
map_transitions <- ggplot(map_data) +
  geom_sf(
    data = map_data,
    aes(fill = rho_1, geometry = geom), 
    color = NA
    ) +
  facet_wrap(~ year, ncol = 2) +  
  scale_fill_viridis_c(
    option = "rocket",
    direction = -1
    ) +
  geom_sf(
    data = brazil, 
    color = "lightgrey",
    fill = NA
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = NA, color = NA),
    legend.key.width = unit(0.2, "cm"),
    legend.title = element_blank()
    ) +
  labs(
    title = "Transition probabilities",
    subtitle = "Yearly conversion rate from natural vegetation to pasture"
    )

ggsave("../Outputs/Graphics/map_transitions.pdf", plot = map_transitions, device = "pdf", width = 10, height = 6)
```

## Pasture quality

```{r}
map_quality <- ggplot(map_data) +
  geom_sf(
    aes(fill = low_share), 
    color = NA
    ) +
  facet_wrap(~ year, ncol = 2) +  
  scale_fill_viridis_c(
    option = "rocket",
    direction = -1
    ) +
  geom_sf(
    data = brazil, 
    color = "lightgrey",
    fill = NA
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = NA, color = NA),
    legend.key.width = unit(0.2, "cm"),
    legend.title = element_blank()
    ) +
  labs(
    title = "Pasture quality",
    subtitle = "Share of pastures with low vegetative vigour by year"
    )

ggsave("../Outputs/Graphics/map_quality.pdf", plot = map_quality, device = "pdf", width = 10, height = 6)
```

## Biomass density

```{r}
map_biomass <- map_data |> 
  filter(year == 2017) |>
  ggplot() +
  geom_sf(
    aes(fill = biomass_density), 
    color = NA
    ) +  
  scale_fill_viridis_c(
    direction = -1
    ) +
  geom_sf(
    data = brazil, 
    color = "lightgrey",
    fill = NA
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = NA, color = NA),
    legend.key.width = unit(0.2, "cm"),
    legend.title = element_blank()
    ) +
  labs(
    title = "Aboveground Biomass",
    subtitle = "Density of AGB in CO2-equivalent tons per hectare"
    )

ggsave("../Outputs/Graphics/map_biomass.pdf", plot = map_biomass, device = "pdf", width = 8, height = 8)
```


# Plots

## Cattle heads

```{r}
plot_ch <- ext_ppm |> 
  summarise(
    ch = sum(cattle_heads),
    .by = c(code_biome, main_biome, year)
  ) |> 
  mutate(
    Bioma = case_when(
      code_biome == 1 ~ "Amazônia",
      code_biome == 2 ~ "Caatinga",
      code_biome == 3 ~ "Cerrado",
      code_biome == 4 ~ "Mata Atlântica",
      code_biome == 5 ~ "Pampa",
      code_biome == 6 ~ "Pantanal")
  ) |> 
  ggplot() +
  # Line plot with color by biome
  geom_line(
    aes(x = year, y = ch, color = Bioma),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "Amazônia" = "#1b9e77", 
      "Caatinga" = "#ffbb78",
      "Cerrado" = "#d95f02",
      "Mata Antlântica" = "#66b3ff",
      "Pampa" = "#d62728",
      "Pantanal" = "#9467bd"
      ),
    name = "Main Biome"
  ) +
  # Labels and titles
  labs(
    title = "Cattle Heads Over Time by Main Biome",
    subtitle = "Regional distribution of cattle heads from 2000 to 2022",
    x = "Year",
    y = "Cattle Heads"
  ) +
  # Improved theme
  theme_minimal() +
  theme(
    axis.text = element_text(color = "black")
  )

ggsave("../Outputs/Graphics/plot_ch.pdf", plot = plot_ch, device = "pdf", width = 10, height = 6)
```

## Pastures

```{r}
land_cover_agg |> 
  left_join(
    select(agg_census_data, c(code_amc, code_biome, main_biome)),
    by = "code_amc"
  ) |> 
  summarise(
    pasture = sum(pasture, na.rm = T),
    .by = c(code_biome, main_biome, year)
  ) |> 
  mutate(
    Bioma = case_when(
      code_biome == 1 ~ "Amazônia",
      code_biome == 2 ~ "Caatinga",
      code_biome == 3 ~ "Cerrado",
      code_biome == 4 ~ "Mata Atlântica",
      code_biome == 5 ~ "Pampa",
      code_biome == 6 ~ "Pantanal")
  ) |> 
  ggplot() +
  # Line plot with color by biome
  geom_line(
    aes(x = year, y = pasture, color = Bioma),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "Amazônia" = "#1b9e77", 
      "Caatinga" = "#ffbb78",
      "Cerrado" = "#d95f02",
      "Mata Antlântica" = "#66b3ff",
      "Pampa" = "#d62728",
      "Pantanal" = "#9467bd"
      ),
    name = "Main Biome"
  ) +
  # Labels and titles
  labs(
    title = "Pasture area Over Time by Main Biome",
    subtitle = "Regional distribution of pastures from 2001 to 2020",
    x = "Year",
    y = "Pasture area (ha)"
  ) +
  # Improved theme
  theme_minimal() +
  theme(
    axis.text = element_text(color = "black")
  )
```

# Structural Parameters

In this section, I will use the preferred empirical exercise to recover the structural parameters that arise from the model.

EXTENSIVE
- delta
- alpha_b
- gamma_x^e
- gamma_t^e
- gamma_biome^e

Exchange
2019	3.9445
2022	5.1642

IPCA
2019    5320.25
2022    6474.09

SCC (2019 US$)
66.00

Annuity/perpetuity equivalent
6.60 (2019 US$)
26.0337 (2019 R$)
31.67981 (2022 R$)


# Regression table

## Intensive margin

```{r}
get_f_stats <- function(model) {
  map(
    list(
      `F (2nd stage)` = fixest::fitstat(model, "f")$f$stat,
      `F (1st stage: local_price)` = fixest::fitstat(model, "ivf")$`ivf1::local_price`$stat,
      `F (1st stage: local_price_2)` = fixest::fitstat(model, "ivf")$`ivf1::local_price_2`$stat,
      `F (1st stage: high_share)` = fixest::fitstat(model, "ivf")$`ivf1::high_share`$stat),
    
    \(x) round(x, 4)
  )
}

# Rename coefficients
coef_rename <- c(
  "fit_local_price" = "$p_{mt}$",
  "fit_local_price_2" = "$p_{mt+1}$",
  "fit_high_share" = "Pasture Quality",
  "year" = "Year"
)

# Add model parameters as an extra column
model_parameters <- data.frame(
  "Parameters" = c(
  "$-\\dfrac{\\alpha_p}{\\delta \\beta}$", "",
  "$\\dfrac{\\alpha_p (1 + \\phi)}{\\delta}$", "",
  "$-\\dfrac{\\gamma_{pasture}}{\\delta}$", "",
  "$-\\dfrac{\\gamma_t}{\\delta}$")
)

# Add controls, fixed effects, and F-statistics as extra rows
extra_rows <- data.frame(
  rowname = c("Controls", 
              "Fixed Effects", 
              "F (2nd stage)", 
              "F (1st stage: $p_{mt}$)", 
              "F (1st stage: $p_{mt+1}$)", 
              "F (1st stage: Pasture Quality)", 
              "Clustered SE"),
  value = c(
    "Temp.; Past.Suit.; Mkt.Acc.", 
    "Biome", 
    get_f_stats(int_mod)[["F (2nd stage)"]], 
    get_f_stats(int_mod)[["F (1st stage: local_price)"]], 
    get_f_stats(int_mod)[["F (1st stage: local_price_2)"]], 
    get_f_stats(int_mod)[["F (1st stage: high_share)"]], 
    "Yes (Municipality)"),
  mod_par = ""
  )

# Name a model list dynamically 
header = paste0("\\hline", "\\vspace{0.05em}", 
                "$h_{mt+1}$", 
                "\\vspace{0.05em}")

model_list = setNames(list(int_mod), header)


# Create the table
modelsummary(
  model_list,
  coef_map = coef_rename,
  gof_map = "nobs",
  fmt = 4, 
  statistic = "{std.error}", 
  stars = c("***"=0.01, "**"=0.05, "*"=0.10), 
  add_rows = extra_rows,
  title = "Intensive Margin IV Regression Results\\label{tab:main_int}",
  notes = paste(
    "Standard errors clustered at the municipality level.",
    "Biome fixed effects.",
    "Controls: Pasture suitability, market access, 
      minimum, maximum, and mean temperature.",
    "Shift-share variables used as instruments for prices.",
    "Lagged precipitation used as instruments for pasture quality."
  ),
  add_columns = model_parameters,
  output = "../Outputs/Tables/main_int_table.tex",
  escape = FALSE
  )

remove(get_f_stats, coef_rename, model_parameters, extra_rows)
```


## Extensive margin

```{r}
get_f_stats <- function(model) {
  map(
    list(`F` = fixest::fitstat(model, "f")$f$stat),
    \(x) round(x, 4)
    )
}

# Rename coefficients
coef_rename <- c(
  "x2" = "$\\frac{\\beta}{2}(h_{mt+1})^2$",
  "high_share" = "Pasture Quality",
  "biomass_density" = "$b_m$",
  "year" = "Year"
)

# Add model parameters as an extra column
model_parameters <- data.frame(
  "Parameters" = c(
  "$\\delta$", "",
  "$-\\gamma_{pasture}^e$", "",
  "$-\\alpha_b$", "",
  "$-\\gamma_t^e$")
)

# Add controls, fixed effects, and F-statistics as extra rows
extra_rows <- data.frame(
  rowname = c("Controls", 
              "Fixed Effects", 
              "F", 
              "Clustered SE"),
  value = c(
    "Temp.; Past.Suit.; Mkt.Acc.", 
    "Biome", 
    get_f_stats(ext_mod)[["F"]], 
    "Yes (Municipality)"),
  mod_par = ""
  )

# Name a model list dynamically 
header = paste0("\\hline", "\\vspace{0.05em}", 
           "$ \\log \\left( \\frac{\\rho_{mt}}{1 - \\rho_{mt}} \\right) 
            -\\beta \\log ( \\rho_{mt+1} ) + \\beta \\gamma $", 
           "\\vspace{0.05em}") 

model_list = setNames(list(ext_mod), header)

# Create the table
modelsummary(
  model_list,
  coef_map = coef_rename,
  gof_map = "nobs",
  fmt = 4, 
  statistic = "{std.error}", 
  stars = c("***"=0.01, "**"=0.05, "*"=0.10), 
  add_rows = extra_rows,
  title = "Extensive Margin FE Regression Results\\label{tab:main_ext}",
  notes = paste(
    "Standard errors clustered at the municipality level.",
    "Biome fixed effects.",
    "Controls: Pasture suitability, market access, 
      minimum, maximum, and mean temperature."
  ),
  add_columns = model_parameters,
  output = "../Outputs/Tables/main_ext_table.tex",
  escape = FALSE
  )


remove(get_f_stats, coef_rename, model_parameters, extra_rows, header, model_list)
```


## Structural parameters

I first define a function to calculate tghe structural parameters, then run and export as latex table.

```{r}
calculate_structural_params <- function(int_model, ext_model) {
  # Extract coefficients and fixed effects from intensive margin
  int_coefs <- coef(int_model)
  int_fixed_effects <- fixef(int_model)$main_biome

  # Calculate intensive margin parameters
  alpha_p_delta <- -0.9 * int_coefs["fit_local_price"]
  phi <- (int_coefs["fit_local_price_2"] / alpha_p_delta) - 1

  # Extract coefficients and fixed effects from extensive margin
  ext_coefs <- coef(ext_model)
  ext_fixed_effects <- fixef(ext_model)$main_biome

  # Calculate extensive margin parameters
  delta <- ext_coefs["x2"]
  alpha_p <- alpha_p_delta * delta
  alpha_b <- - ext_coefs["biomass_density"]
  gamma_pasture_e <- - ext_coefs["high_share"]
  gamma_year_e <- - ext_coefs["year"]

  # Back to intensive margin
  gamma_pasture <- - int_coefs["fit_high_share"] * delta
  gamma_year <- - int_coefs["year"] * delta

  # multiply fixed effects by delta
  
  biomes = c(
    "amazonia", "caatinga", "cerrado", "mata atlantica", "pampa", "pantanal"
  )
  
  gamma_biome <- map_vec(int_fixed_effects, function(fe) - fe * delta)
  names(gamma_biome) <- paste("$\\gamma_g: g =$", biomes)
                        
  gamma_biome_e <- map_vec(ext_fixed_effects, function(fe) - fe * delta)
  names(gamma_biome_e) <- paste("$\\gamma_g^e: g =$", biomes)
                          
  # Combine parameters into a data frame
  result <- data.frame(
    Parameter = c(
      "$\\phi$", "$\\delta$", "$\\alpha_p$", "$\\alpha_b$",
      "$\\gamma_{pasture}$", 
      "$\\gamma_t$",
      names(gamma_biome), 
      "$\\gamma_{pasture}^e$",
      "$\\gamma_t^e$",
      names(gamma_biome_e)
      ),
    
    Value = c(
      phi, delta, alpha_p, alpha_b,
      gamma_pasture, gamma_year,
      unname(gamma_biome), 
      gamma_pasture_e,
      gamma_year_e,
      unname(gamma_biome_e) 
      ),
    
    # Add column with parameters divided by alpha_p
    Scaled = c(
      NA,
      NA,
      NA,
      map_vec(c(alpha_b,
            gamma_pasture, gamma_year, unname(gamma_biome),
            gamma_pasture_e, gamma_year_e, unname(gamma_biome_e)),
          \(x) x / alpha_p)
      )
  )
  
  return(result)
}
```

Running the function.

```{r} 
calculate_structural_params(int_mod, ext_mod) |> 
  kbl(
    digits = c(4,4,2),
    
    # configure header
    col.names = c(
      paste0("\\hline", "\\vspace{0.05em}",
        "Parameter",
        "\\vspace{0.05em}"),
      "Value", 
      "Scaled by $\\alpha_p$ (R\\$)"
      ),
    
    booktabs = T,
    label = "tab:str_param",
    caption = "Structural Parameters",
    format = "latex",
    escape = FALSE,
    linesep = "\\addlinespace"
  ) |>
  kable_styling(
    full_width = T,
    htmltable_class =  "lightable-classic-2"
  ) |> 
  pack_rows("Intensive margin cost factors", 5, 12, latex_gap_space = "1em") |> 
  pack_rows("Extensive margin cost factors", 13, 20, latex_gap_space = "1em") |> 
  save_kable("../Outputs/Tables/str_param_table.tex")
```


