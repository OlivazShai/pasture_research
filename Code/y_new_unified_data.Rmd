---
title: "Data Unification"
author: "Shai Vaz"
date: "May 2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Data Wrangling
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(readxl)

# Graphics
library(ggplot2)

# Geographic
library(sf)

# Econometrics
library(fixest)
library(ivreg)
```

# Importing files

```{r}
bulk_read_rds(
  national_prices,
  cattle_prices_cepea_in_census_years,
  agg_census_data,
  ssiv
  )
```

# Joining quantities, prices and shifters

```{r}
joined_data <- left_join(
  # first I join shifters with prices
  # then I extract data from t+1
  ssiv |> 
    select(code_amc, year, area_amc, ssiv),
  
  cattle_prices_cepea_in_census_years,
  
  by = c("year" = "census_year")
  ) |> 
  # get next period prices and shifters
  mutate(
    mean_price_2 = if_else(
      year == 2006 | year == 2017,
      lead(mean_price),
      NA),
    
    ssiv_2 = if_else(
      year == 2006 | year == 2017,
      lead(ssiv),
      NA)
  ) |>
  # join with census data
  right_join(
    agg_census_data,
    
    by = c("code_amc", "year")
  ) |> 
  # projecting local prices ahead 
  mutate(
    local_price = av_price_slaughter,
    local_price_2 = (av_price_slaughter/mean_price)*mean_price_2
  )
```

# Regression

```{r}
feols(
  data = joined_data,
  cattle_heads_big ~ 1 | local_price + local_price_2 ~ ssiv + ssiv_2
  ) 
```
