---
title: "Data Unification"
author: "Shai Vaz"
date: "May 2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Data Wrangling
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(readxl)
library(forcats)

# Graphics
library(ggplot2)

# Geographic
library(sf)

# Econometrics
library(fixest)
library(ivreg)
```

# Importing files

```{r}
bulk_read_rds(
  national_prices,
  cattle_prices_cepea_in_census_years,
  agg_census_data,
  ssiv
  )
```

# Joining quantities, prices and shifters

```{r}
joined_data <- left_join(
  # first I join shifters with prices
  # then I extract data from t+1
  ssiv |> 
    select(code_amc, year, area_amc, ssiv),
  
  cattle_prices_cepea_in_census_years,
  
  by = c("year" = "census_year")
  ) |> 
  # get next period prices and shifters
  mutate(
    mean_price_2 = if_else(
      year == 2006 | year == 2017,
      lead(mean_price),
      NA),
    
    ssiv_2 = if_else(
      year == 2006 | year == 2017,
      lead(ssiv),
      NA)
  ) |>
  # join with census data
  right_join(
    agg_census_data,
    
    by = c("code_amc", "year")
  ) |>  
  mutate(
    # projecting local prices ahead
    local_price = av_price_slaughter*1000,
    local_price_2 = (av_price_slaughter/mean_price)*mean_price_2*1000,
    # fixed efects
    fe_amc = as_factor(code_amc)
  )
```

# Regression

## Todo mundo

```{r}
m1 <- feols(
  data = joined_data,
  sw(cattle_heads_big, cattle_heads_big/area_amc) ~ 1 | csw(1,main_biome,year) | local_price + local_price_2 ~ ssiv + ssiv_2,
   panel.id = c("code_amc","year"),
  cluster = "fe_amc"
  )

m2 <- feols(
  data = joined_data,
  cattle_heads_big ~ 1 | csw(1,main_biome,year) | local_price + local_price_2 ~ ssiv + ssiv_2,
   panel.id = c("code_amc","year"),
  cluster = "fe_amc"
  )

etable(
    m2,
    stage = 2,
    tex = T,
    fitstat = ~ n + f + ivfall
    )
```

## amazonia

```{r}
feols(
  data = joined_data |> filter(code_biome == 1),
  cattle_heads_big ~ 1 | local_price + local_price_2 ~ ssiv + ssiv_2
  ) |> 
  etable()
```

## cerrado

```{r}
feols(
  data = joined_data |> filter(code_biome == 3),
  cattle_heads_big ~ 1 | local_price + local_price_2 ~ ssiv + ssiv_2
  ) |> 
  etable()
```

# Diagnostics

```{r}
a <- joined_data |> 
  mutate(
    fe = as_factor(code_amc),
    fe_2 = as_factor(main_biome)
  ) |> 
  drop_na() |> 
  filter(
    cattle_heads_big != 0
  )
```

```{r}
first_stage1 <- lm(local_price ~ ssiv, data = a)
first_stage2 <- lm(local_price_2 ~ ssiv_2, data = a)

# Extract predicted values
a$local_price_hat <- predict(first_stage1)
a$local_price_2_hat <- predict(first_stage2)
```

```{r}
iv_model <- ivreg(
  cattle_heads_big ~ local_price_hat + local_price_2_hat:fe_2 + fe_2, 
  data = a
)


summary(iv_model)
```

## FE without IV

```{r}
feols(
  data = a,
  cattle_heads_big ~ local_price + local_price_2 | fe + year
  ) |> 
  etable()
```
