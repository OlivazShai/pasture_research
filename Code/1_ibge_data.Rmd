---
title: "IBGE Data"
author: "Shai Vaz"
date: "Abril 2024"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Data Wrangling
library(dplyr)
library(tidyr)
library(stringr)
library(readr)

# Graphics
library(ggplot2)

# Geographic
library(sf)
library(sidrar)
library(geobr)

# Personal functions
source("../Functions/functions.R")
```

# Legal Amazon

We define states and municipalities in the Legal Amazon. All municipalities in the states are part of the LA, except for Maranhão, where only those left of the 14th meridian are considered.

```{r}
amazon_states = c(
  11:17, # Regiao Norte
  21, # Maranhão
  51 # Mato Grosso
  )
```

# PPM Data (Sidra)

Cattle stock by municipality, from 1995 to 2022.

```{r}
# Define list of geographic filters
# Some regions need division due to data limits

filter_list = list(
  # North
  list("Region" = 1),
  # Northeast
  list("State" = 21:24),
  list("State" = 25:29),
  # Southeast
  list("State" = 31:32),
  list("State" = c(33,35)), # there's no State 34
  # South
  list("Region" = 4),
  # Midwest
  list("Region" = 5)
)

# Initialise an empty data frame to store the aggregated data
ppm <- data.frame()

# Loop through each geo filter

for (filter in filter_list) {
  
  # Import data for the current region
  x <- get_sidra(
    x = 3939, # Efetivo dos rebanhos, por tipo de rebanho
    variable = 105,  # Efetivo dos rebanhos (Cabeças)
    period = as.character(1995:2022),
    classific = list("C79"), # Tipo de rebanho:
    category = list(2670), # Bovinos
    format = 4, # códigos e descrição
    geo = "City", # detalhe espacial
    geo.filter = filter
  )
  
  # Track job
  print(filter)
  
  # Append the data to the aggregated data frame
  ppm <- bind_rows(ppm, x)
}

rm(x, filter, filter_list)
```

Cleaning data.

```{r}
cattle_heads_ppm <- ppm %>% 
  select(
    "Valor",
    "Município (Código)",
    "Município",
    "Ano"
  ) %>% 
  rename(
    cattle_heads = "Valor",
    code_muni = "Município (Código)",
    name_muni = "Município",
    year = "Ano"
  ) %>% 
  mutate(
    name_state = str_split_i(name_muni, " - ", 2),
    code_state = str_sub(code_muni, start = 1, end = 2),
    name_muni = str_split_i(name_muni, " - ", 1)
  ) %>% 
  relocate(year, code_muni, name_muni, code_state, name_state, cattle_heads)
```

# Census Data (Sidra)

## 2017 Census data

```{r}
census_variables = c(
    # Discriminated by farm size (in heads) and finality

    9521, # Cattle heads - small farms (<50h)
    9523, # Sold heads - small farms
    9743, # Sale value - small farms

    2059, # Cattle heads - big farms (>50h)

    9525, # Breeding stock sold - big farms 
    9745, # Sale value Br.St. - big farms

    9527, # Sold for finishing - big farms 
    9747, # Sale value for finishing - big farms 

    9529, # Sold for slaughter - big farms
    9749 # Sale value for slaughter - big farms  
    )

census_names = c(
  "cattle_heads_small",
  "heads_sold_small",
  "sales_value_small",
  
  "cattle_heads_big",
  "heads_sold_big_breed",
  "sales_value_big_breed",
  
  "heads_sold_big_finish",
  "sales_value_big_finish",
  
  "heads_sold_big_slaughter",
  "sales_value_big_slaughter"
)
```

```{r}
for (i in 1:10) {
  census_name_i = census_names[i]
  census_variable_i = census_variables[i]
  print(i)
  
  census_i <- get_sidra(
    x = 6910, # Cattle headcounts and sales
    variable = census_variable_i,
    classific = "c829", # Tipology
    category = list("46302"), # Only return totals
    geo = "City", # Municipality level data
    format = 3, # Names and codes for geo levels  
    digits = "max" # Maximum digits
  ) %>% 
  # Cleaning
  rename(
    "code_muni" = "Município (Código)",
    "name_muni" = "Município"
  ) %>%
  rename_with(
    .cols = "Valor",
    .fn = \(x) census_name_i
  ) %>% 
  select(
    name_muni,
    code_muni,
    {{census_name_i}}
  ) %>% 
  mutate(
    name_state = str_split_i(name_muni, " - ", 2),
    code_state = str_sub(code_muni, start = 1, end = 2),
    name_muni = str_split_i(name_muni, " - ", 1)
  ) %>% 
  relocate(name_muni, code_muni, name_state, code_state, {{census_name_i}})
  
  # Joining variables
  if (i == 1) {
    cattle_sales_census = census_i
  } else {
    cattle_sales_census = full_join(
      cattle_sales_census,
      census_i,
      by = join_by(
        "name_muni", "code_muni", "name_state", "code_state"
      )
    )
      
    }
  
}

remove(census_i, census_name_i, census_variable_i)

```

```{r}
remove(census_names, census_variables, i)
```

## 2017 Average Prices

Now, I'll use census sales data to extract average cattle price per municipality. I only use sales for slaughter from large farms.

```{r}
cattle_prices_2017_census <- cattle_sales_census %>%
  replace(
    is.na(.), 0
  ) %>% 
  mutate(
    average_price =
      (sales_value_big_slaughter)/
      (heads_sold_big_slaughter)
  ) %>% 
  drop_na(
    average_price
  ) %>% 
  select(
   code_muni,
   name_muni,
   code_state,
   name_state,
   average_price
  )
```

# Geographic files

## Municipality polygons

```{r}
municipalities <- read_municipality(
  code_muni = "all", 
  year = 2022,
  simplified = FALSE
  ) %>% 
  mutate(
    code_muni = as.character(code_muni)
  )
```

**Lagoa dos Patos** (4300001) e **Lagoa Mirim** (4300002) are lakes, included by IBGE for legal reasons.

```{r}
municipalities <- municipalities %>%
  filter(
    ! code_muni %in% c(4300001,4300002)
  )
```

## Conservation Units

```{r}
conservation_units <- read_conservation_units(
  date = 201909,
  simplified = FALSE
  )
```

## Indigenous Lands

```{r}
indigenous_lands <- read_indigenous_land(
  date = 201907,
  simplified = FALSE
)
```

## AMCs - Historically comparable municipalities

This database is organized by AMC. In the column `list_code_muni_2010` we have a string, listing all 2010 municipalities in each AMC.

```{r}
amc_1991 <- read_comparable_areas(
  start_year = 1991,
  end_year = 2010,
  simplified = FALSE
  ) %>% 
  select(
    -list_name_muni_2010 # superfluous column
  ) %>%
  mutate(
    code_amc = as.character(code_amc)
  ) %>% 
  # There's one polygon self intersecting, we need to make it valid 
  st_make_valid()
```

### By municipality

Here, I'll disagregate `amc_1991` by 2010 municipality

```{r}
amc_1991_by_muni <- amc_1991 %>% 
  mutate(
    code_muni = str_split(
      list_code_muni_2010,
      pattern = ","
    )
  ) %>%
  select(
    -list_code_muni_2010
  ) %>% 
  unnest_longer(
    code_muni
  ) %>% 
  # Get municipality names
  left_join(
    municipalities %>% 
      as_tibble() %>% 
      select(1:2, 4),
    
    by = "code_muni"
  ) 
```

### Municipalities cover in AMCs

There are a few new municipalities which are not covered by the 2010 AMCs.

```{r}
muni_not_in_amc <- anti_join(
    municipalities %>% 
      as_tibble() %>% 
      select(1,2,4),
    
    amc_1991_by_muni%>% 
      as_tibble() %>% 
      select(1:2),
    by = c("code_muni")
  )
```

Simply intersecting these municipalities with the AMCs does not work. The solution won't be simply geographical, but historical. We verify externally from which municipalities these ones split from. I'll list the new municipalities, the municipalities they split from, and the AMC from the old municipalities.

**Mojuí dos campos** split from Santarem PA - 2020\
**Pescaria brava** split from Laguna SC - 14440\
**Balneario rincão** split from Içara SC - 14413\
**Pinto Bandeira** split from Bento Gonçalves RS - 15038

**Paraíso das Aguas** (MS) split from three different AMCs\
- Água Clara = \~ 1085 (1 municipio)\
- Costa Rica = \~ 1103 (3 munis)\
- Chapadão do Sul = 1107 (1 munis)

### New AMCs

I'll start a new series of AMC codes starting in 990XX. These new codes will substitute the codes from the AMCs where new municipalities were created. I'll also have to agregate the geometry for the three AMCs which disagregated.

```{r}
muni_not_in_amc <- muni_not_in_amc %>% 
  mutate(
    code_amc = case_when(
      name_muni == "Mojuí Dos Campos" ~ "99001",
      name_muni == "Pescaria Brava" ~ "99002",
      name_muni == "Balneário Rincão" ~ "99003",
      name_muni == "Pinto Bandeira" ~ "99004",
      name_muni == "Paraíso Das Águas" ~ "99005"
    )
  )
```

The process is the following. First, I'll append these rows to the AMC dataframe. Second, I'll change the codes of all the cities in the same AMCs as the new cities to the new codes. Third, I'll define the geometry as the union of the older AMCs geometries, so all three AMCs related to Paraíso das Águas are agregated into the same polygon.

```{r}
# Define the `code_amc` values that need unioning
amc_to_union <- c("99001", "99002", "99003", "99004", "99005")

muni_to_amc <- amc_1991_by_muni %>%
  # append the new municipalities
  bind_rows(muni_not_in_amc) %>% 
  # define as sf
  st_as_sf() %>% 
  # Update AMC codes
  mutate(
    code_amc = case_when(
      code_amc == "2020" ~ "99001",
      code_amc == "14440" ~ "99002",
      code_amc == "14413" ~ "99003",
      code_amc == "15038" ~ "99004",
      # Paraíso das Águas:
      code_amc == "1085" ~ "99005",
      code_amc == "1103" ~ "99005",
      code_amc == "1107" ~ "99005",
      .default = code_amc
    )
  )  %>% 
  # Group municipalities by AMC
  group_by(code_amc) %>%
  # Union only the specified groups
  mutate(
    geom = if_else(
      code_amc %in% amc_to_union, 
      st_union(geom), 
      geom)
  ) %>% 
  ungroup()

```

Now we remove the auxiliary dataframes used up until here.

```{r}

rm(amc_1991, amc_1991_by_muni, muni_not_in_amc)
```

## Biomes

Simplified dataframe, without topology errors in the sphere.

```{r}
biomes_simplified <- read_biomes(
  year = 2019, 
  # Will use simplified geometry because original resolution has 
  # invalid unsolvable geometry for amazon, an issue has been raised.
  # The problem comes from original IBGE data
  # I'll improve this when developers correct the issue 
  simplified = TRUE
  ) %>% 
  mutate(
    # simplify biome names
    name_biome = name_biome %>% 
      stringi::stri_trans_general(., "Latin-ASCII") %>% 
      str_replace(.," ", "_") %>% 
      str_to_lower()
  )
```

Unsimplified dataframe, has topology error when using s2

```{r}
biomes <- read_biomes(
  year = 2019, 
  # Usage of this df depends of s2 turned off 
  simplified = FALSE
  ) %>% 
  mutate(
    # simplify biome names
    name_biome = name_biome %>% 
      stringi::stri_trans_general(., "Latin-ASCII") %>% 
      str_replace(.," ", "_") %>% 
      str_to_lower()
  )
```

### Municipalities by biome

```{r}
bulk_read_rds(municipalities)
```

```{r}
municipalities_with_biomes <- bind_cols(
  municipalities,
  
  # intersection municipalities and biomes
  st_intersects(
    municipalities,
    biomes,
    sparse = FALSE
  ) %>% 
  as_tibble(.name_repair="minimal") %>% 
  setNames(
    biomes$name_biome
  ) %>% 
  select(
    -sistema_costeiro
  )
  )
```

### AMCs with biomes

```{r}
amc_1991_with_biomes <- bind_cols(
  amc_1991,
  
  # intersection AMCs and biomes
  st_intersects(
    amc_1991,
    biomes,
    sparse = FALSE
  ) %>% 
  as_tibble(.name_repair="minimal") %>% 
  setNames(
    biomes$name_biome
  ) 
) %>% 
  select(
    -sistema_costeiro
  )
```

## Generate RDSs

```{r}
bulk_write_rds(
  cattle_heads_ppm,
  cattle_sales_census, 
  cattle_prices_2017_census,
  municipalities, 
  conservation_units, 
  indigenous_lands,
  muni_to_amc,
  biomes
  )
```
